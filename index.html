<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Animate a series of images</title>
<link rel="icon" href="data:;base64,iVBORwOKGO=" />
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>

<!-- Papa Parse for csv parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.7/papaparse.min.js"></script>


<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  #message { position: relative; top: 20px; left: 20px; background: #fff; border: 1px solid #555; border-radius: 10px; z-index: 99999; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; font-size: 25px; font-weight: 500; font-family: sans-serif; }
</style>
</head>

<body>

<div id="map">
  <div id="message">1</div>
</div>


<script>

  // TNC MB TOKEN
  const MAPBOX_TOKEN  = 'pk.eyJ1IjoibmF0aGFuaWVscmluZGxhdWIiLCJhIjoiY2pqcmQ4cTU4MmdvaDN2bzF0Yjd5b29ucyJ9.YU0K_oBS-qHGQ8S0ExUYnQ'

  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/nathanielrindlaub/ck2xppe0z1ll01dmr159zbqza',
    maxZoom: 17,
    minZoom: 4,
    zoom: 10.03,
    center: [-121.873869, 36.4391176],
  });
 
  function addRasterLayer(i, urls) {
    console.log(urls[i]['TiTiler URL'])
    map.addSource('kelp' + i, {
      'type'       : 'raster',
      'tiles'      : [urls[i]['TiTiler URL']],
      'tileSize'   : 256,
    });
 
    map.addLayer({
      'id'     : 'kelp' + i,
      'type'   : 'raster',
      'source' : 'kelp' + i,
      'paint'  : {
        'raster-opacity': 0
      }
    });
  }

  function setRasterLayerVisibility(id, opacity, transition = {duration:0, delay:0}) {
    map.setPaintProperty(id, 'raster-opacity-transition', transition);
    map.setPaintProperty(id, 'raster-opacity', opacity);
  }

  function showRasterLayer(id) {
    setRasterLayerVisibility(id, 1);
  }
   
  function hideRasterLayer(id) {
    setRasterLayerVisibility(id, 0);
  }

  // Start things off by getting the CSV of tile URLs
  fetch('./tile_urls.csv').then((response) => {
    if (response.ok) {
      return response.text();
    }
    return Promise.reject(response)
  }).then(function(text) {
    const parsed = Papa.parse(text, {header: true, skipEmptyLines: 'greedy'});
    const urls = parsed.data;
    console.log(urls);

    // let frameCount = urls.length;
    let frameCount = 10;

    let currentImageOffset = 0;
    let lastImageOffset = 0;

    // Create and add the map source and map layers from the URLs
    map.on('load', () => {
      // load all of the tiles at 0 opacity
      for (let i = 0; i < frameCount; i++) {
        addRasterLayer(i, urls);
      }

      // show the very first one
      showRasterLayer('kelp0');

      // then show and hide one every second, one by one, changing opacity from 0 to 1 at each step
      setInterval(() => {
        lastImageOffset = currentImageOffset;
        currentImageOffset++;
    
        if (currentImageOffset >= frameCount) currentImageOffset = 0;
    
        hideRasterLayer('kelp' + lastImageOffset);
        showRasterLayer('kelp' + currentImageOffset);

        msg = document.getElementById('message');
        msg.innerText = '' + (currentImageOffset + 1);
      
      }, 1000);

    });

    // start animating
    // const interval = setInterval(() => {

    //   // currentImage = (currentImage + 1) % frameCount;
    //   // map.getSource('radar').updateImage({ url: getPath() });
    //   map.removeLayer(layer);
    //   map.removeSource(source);
    //   sourcecount += 1;
    //   source = sourceroot + sourcecount;
    //   layer = `${source}-layer`;

    //   let tile = urls[sourcecount]['TiTiler URL'];

    //   map.addSource(source, {
    //     type: 'raster',
    //     tiles: [tile],
    //   });

    //   map.addLayer({
    //     id: layer,
    //     'type': 'raster',
    //     'source': source,
    //   });

    //   console.log(sourcecount)
    //   if (sourcecount >= urls.length) {
    //     clearInterval(interval)
    //   }

    // }, 1000);


  }).catch((error) => {
    console.log('Something went wrong.', error)
  });




</script>
 
</body>
</html>