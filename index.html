<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Animate a series of images</title>
<link rel="icon" href="data:;base64,iVBORwOKGO=" />
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>

<!-- Papa Parse for csv parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.7/papaparse.min.js"></script>


<style>
  body { 
    margin: 0; padding: 0; 
  }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  
  select {
    font-size: 25px; font-weight: 500; font-family: sans-serif;

    height: 50px;
    width: auto;
    position: relative;
    top: 20px;
    left: 20px;
    z-index: 100000;
    padding:  0 1em;
  }

  select:disabled {
    cursor: not-allowed;
  }

  #message { 
    font-size: 25px; font-weight: 500; font-family: sans-serif;
    position: relative; 
    top: 40px; left: 20px; 
    background: #fff; 
    border: 1px solid #555; 
    border-radius: 10px; 
    z-index: 99999; 
    width: 50px; 
    height: 50px; 
    display: flex; justify-content: center; align-items: center; 
  }
</style>
</head>

<body>

<div id="map">
  <select disabled id="number" onchange="select_change()">
    <option selected value="10">Animate first 10 URLs</option>
    <option value="20">Animate first 20 URLs</option>
    <option value="30">Animate first 30 URLs</option>
    <option value="40">Animate first 40 URLs</option>
    <option value="50">Animate first 50 URLs</option>
    <option value="117">Animate All</option>
  </select>
  <div id="message">1</div>
</div>


<script>

  frameCount = 10;

  function select_change() {
    let d = document.getElementById('number').value;
    doInterval(d);
  }

  // TNC MB TOKEN
  const MAPBOX_TOKEN  = 'pk.eyJ1IjoibmF0aGFuaWVscmluZGxhdWIiLCJhIjoiY2pqcmQ4cTU4MmdvaDN2bzF0Yjd5b29ucyJ9.YU0K_oBS-qHGQ8S0ExUYnQ'

  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/nathanielrindlaub/ck2xppe0z1ll01dmr159zbqza',
    maxZoom: 17,
    minZoom: 4,
    zoom: 10.03,
    center: [-121.873869, 36.4391176],
  });
 
  function addRasterLayer(i, urls) {
    console.log(urls[i]['TiTiler URL'])
    map.addSource('kelp' + i, {
      'type'       : 'raster',
      'tiles'      : [urls[i]['TiTiler URL']],
      'tileSize'   : 256,
    });
 
    map.addLayer({
      'id'     : 'kelp' + i,
      'type'   : 'raster',
      'source' : 'kelp' + i,
      'paint'  : {
        'raster-opacity': 0
      }
    });
  }

  function setRasterLayerVisibility(id, opacity, transition = {duration:0, delay:0}) {
    map.setPaintProperty(id, 'raster-opacity-transition', transition);
    map.setPaintProperty(id, 'raster-opacity', opacity);
  }

  function showRasterLayer(id) {
    setRasterLayerVisibility(id, 1);
  }
   
  function hideRasterLayer(id) {
    setRasterLayerVisibility(id, 0);
  }

  function doInterval(frameCount) {
    let currentImageOffset = 0;
    let lastImageOffset = 0;

    if( window.currentInterval != undefined && window.currentInterval != 'undefined' ){
        window.clearInterval(window.currentInterval);
    }

    // show and hide one every second, one by one, changing opacity from 0 to 1 at each step
    window.currentInterval = setInterval(() => {
      lastImageOffset = currentImageOffset;
      currentImageOffset++;
  
      if (currentImageOffset >= frameCount) currentImageOffset = 0;
  
      hideRasterLayer('kelp' + lastImageOffset);
      showRasterLayer('kelp' + currentImageOffset);

      msg = document.getElementById('message');
      msg.innerText = '' + (currentImageOffset + 1);
    
    }, 1000);

  }

  // Start things off by getting the CSV of tile URLs
  fetch('./tile_urls.csv').then((response) => {
    if (response.ok) {
      return response.text();
    }
    return Promise.reject(response)
  }).then(function(text) {
    const parsed = Papa.parse(text, {header: true, skipEmptyLines: 'greedy'});
    const urls = parsed.data;
    console.log(urls);

    // Create and add the map source and map layers from the URLs
    map.on('load', () => {
      // load ALL of the tiles at 0 opacity
      for (let i = 0; i < urls.length; i++) {
        addRasterLayer(i, urls);
      }

      // show the very first one
      showRasterLayer('kelp0');

      // do the interval, but only for the default number of URLs specified at the top
      doInterval(frameCount);

      // enable the select now that we're all loaded
      document.getElementById('number').removeAttribute('disabled');
    });

  }).catch((error) => {
    console.log('Something went wrong.', error)
  });




</script>
 
</body>
</html>